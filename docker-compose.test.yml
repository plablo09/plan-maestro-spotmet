# Test orchestration
services:
  backend-test:
    image: python:3.11-slim
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - PYTHONPATH=/app
    command: >
      sh -c "
      apt-get update && apt-get install -y libsqlite3-dev &&
      pip install --upgrade pip &&
      pip install fastapi uvicorn duckdb geopandas pyogrio pyarrow pytest pytest-asyncio httpx &&
      pytest
      "

  frontend-test:
    image: node:20-slim
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
      npm install &&
      npm test
      "

  e2e-test:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - PYTHONPATH=/app
      - CI=true
    command: >
      sh -c "
      apt-get update && apt-get install -y python3.11 python3-pip libsqlite3-dev libgdal-dev g++ &&
      pip install -r backend/requirements.txt &&
      pip install pytest pytest-asyncio httpx &&
      npm install &&
      npx playwright install chromium &&
      npm run test:e2e
      "
